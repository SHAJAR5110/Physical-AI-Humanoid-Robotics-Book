openapi: 3.0.0
info:
  title: Physical AI Book MVP - REST API
  version: 1.0.0
  description: |
    REST API for Physical AI & Humanoid Robotics Book MVP.

    Provides endpoints for:
    - User authentication (signup, signin, signout)
    - Chapter retrieval (list, get by ID)
    - Personalization (rewrite chapter for user profile)
    - Translation (translate chapter to Urdu)
    - RAG Chat (semantic search + Claude API responses)

    All endpoints except `/auth/signup` require valid session token in Authorization header.

servers:
  - url: https://physical-ai-book-backend.render.com/api
    description: Production (Render)
  - url: http://localhost:8000/api
    description: Local development

tags:
  - name: auth
    description: Authentication (signup, signin, signout)
  - name: chapters
    description: Retrieve book chapters
  - name: personalization
    description: Generate personalized chapter content
  - name: translation
    description: Translate chapters to Urdu
  - name: chat
    description: RAG chatbot with semantic search

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: Session token from BetterAuth

  schemas:
    User:
      type: object
      required: [id, email, name]
      properties:
        id:
          type: string
          format: uuid
          description: User ID
        email:
          type: string
          format: email
          description: User email address
        name:
          type: string
          description: User display name
        os:
          type: string
          enum: [linux, macos, windows, null]
          description: Operating system (for personalization)
        gpu:
          type: string
          description: GPU model (e.g., nvidia-rtx-4090)
        experience_level:
          type: string
          enum: [beginner, intermediate, advanced, null]
          description: Self-reported skill level
        robotics_background:
          type: boolean
          description: Whether user has robotics experience
        created_at:
          type: string
          format: date-time
          description: User creation timestamp

    Session:
      type: object
      required: [session_id, user_id, expires_at]
      properties:
        session_id:
          type: string
          format: uuid
          description: Session ID
        user_id:
          type: string
          format: uuid
          description: Associated user ID
        expires_at:
          type: string
          format: date-time
          description: Session expiration time (24h from creation)

    Chapter:
      type: object
      required: [id, title, slug, content]
      properties:
        id:
          type: integer
          description: Chapter ID (1-6 for MVP)
        title:
          type: string
          description: Chapter title
        slug:
          type: string
          description: URL-friendly identifier (e.g., intro, ros2)
        content:
          type: string
          description: Full markdown content with code blocks
        summary:
          type: string
          description: 200-word chapter preview
        author:
          type: string
          description: Chapter author
        version:
          type: string
          description: Semantic version (e.g., 1.0)
        page_count:
          type: integer
          description: Estimated page count

    PersonalizedContent:
      type: object
      required: [id, user_id, chapter_id, personalized_text]
      properties:
        id:
          type: string
          format: uuid
        user_id:
          type: string
          format: uuid
        chapter_id:
          type: integer
        personalized_text:
          type: string
          description: Claude API rewrite for user profile
        created_at:
          type: string
          format: date-time
        expires_at:
          type: string
          format: date-time

    Citation:
      type: object
      required: [chapter_id, section_title]
      properties:
        chapter_id:
          type: integer
          description: Chapter ID cited
        section_title:
          type: string
          description: Section within chapter
        excerpt:
          type: string
          description: Text excerpt from source

    ChatMessage:
      type: object
      required: [id, user_id, user_message, assistant_response]
      properties:
        id:
          type: string
          format: uuid
        user_id:
          type: string
          format: uuid
        chapter_id:
          type: integer
          description: Chapter context where chat was initiated
        user_message:
          type: string
          description: User question or prompt
        assistant_response:
          type: string
          description: Claude API response
        citations:
          type: array
          items:
            $ref: '#/components/schemas/Citation'
          description: Array of citations (SC-006)
        created_at:
          type: string
          format: date-time

    ErrorResponse:
      type: object
      required: [error, status]
      properties:
        error:
          type: string
          description: Error message
        status:
          type: integer
          description: HTTP status code
        timestamp:
          type: string
          format: date-time
          description: Error timestamp

  responses:
    Unauthorized:
      description: Missing or invalid session token
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error: Unauthorized - invalid or expired token
            status: 401

    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error: Chapter not found
            status: 404

    ServerError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error: Internal server error
            status: 500

paths:
  /auth/signup:
    post:
      summary: Register new user
      description: |
        Create new user account via BetterAuth.

        **No authentication required**

        Returns user profile and session token.
      operationId: signupUser
      tags: [auth]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email, password, name]
              properties:
                email:
                  type: string
                  format: email
                  example: alice@example.com
                password:
                  type: string
                  format: password
                  example: SecurePassword123!
                name:
                  type: string
                  example: Alice Chen
                os:
                  type: string
                  enum: [linux, macos, windows]
                  example: linux
                gpu:
                  type: string
                  example: nvidia-rtx-4090
                experience_level:
                  type: string
                  enum: [beginner, intermediate, advanced]
                  example: intermediate
                robotics_background:
                  type: boolean
                  example: true
      responses:
        201:
          description: User created successfully
          content:
            application/json:
              schema:
                type: object
                required: [user, session_token]
                properties:
                  user:
                    $ref: '#/components/schemas/User'
                  session_token:
                    type: string
                    format: jwt
                    description: Bearer token for subsequent requests
                  expires_at:
                    type: string
                    format: date-time
                    example: 2025-12-07T14:30:00Z
        400:
          description: Invalid input (email already registered, weak password, etc.)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: Email already registered
                status: 400
        500:
          $ref: '#/components/responses/ServerError'

  /auth/signin:
    post:
      summary: User login
      description: |
        Authenticate user by email and password.

        **No authentication required**

        Returns session token with 24-hour expiration.
      operationId: signinUser
      tags: [auth]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email, password]
              properties:
                email:
                  type: string
                  format: email
                password:
                  type: string
                  format: password
      responses:
        200:
          description: Successfully authenticated
          content:
            application/json:
              schema:
                type: object
                required: [session_token, expires_at, user]
                properties:
                  session_token:
                    type: string
                    format: jwt
                  expires_at:
                    type: string
                    format: date-time
                  user:
                    $ref: '#/components/schemas/User'
        401:
          description: Invalid email or password
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: Invalid email or password
                status: 401
        500:
          $ref: '#/components/responses/ServerError'

  /auth/signout:
    post:
      summary: User logout
      description: Invalidate current session token
      operationId: signoutUser
      tags: [auth]
      security:
        - BearerAuth: []
      responses:
        200:
          description: Successfully signed out
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Successfully signed out
        401:
          $ref: '#/components/responses/Unauthorized'
        500:
          $ref: '#/components/responses/ServerError'

  /chapters:
    get:
      summary: List all chapters
      description: |
        Retrieve list of all 6 book chapters.

        **Optional authentication**: Returns less detail if unauthenticated.
      operationId: listChapters
      tags: [chapters]
      security:
        - BearerAuth: []
      responses:
        200:
          description: List of chapters
          content:
            application/json:
              schema:
                type: object
                required: [chapters]
                properties:
                  chapters:
                    type: array
                    items:
                      type: object
                      properties:
                        id:
                          type: integer
                        title:
                          type: string
                        slug:
                          type: string
                        summary:
                          type: string
                        author:
                          type: string
                        page_count:
                          type: integer
              example:
                chapters:
                  - id: 1
                    title: Introduction to Physical AI
                    slug: intro
                    summary: Overview of Physical AI...
                    author: Dr. Pieter Abbeel
                    page_count: 12
                  - id: 2
                    title: ROS 2 Fundamentals
                    slug: ros2
                    summary: Introduction to Robot Operating System 2...
                    author: Community
                    page_count: 18
        500:
          $ref: '#/components/responses/ServerError'

  /chapters/{chapter_id}:
    get:
      summary: Get chapter by ID
      description: |
        Retrieve full chapter content with markdown and code blocks.

        **Optional authentication**: Includes user-specific metadata if authenticated.
      operationId: getChapter
      tags: [chapters]
      parameters:
        - name: chapter_id
          in: path
          required: true
          schema:
            type: integer
            minimum: 1
            maximum: 6
          example: 1
      security:
        - BearerAuth: []
      responses:
        200:
          description: Chapter content
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Chapter'
        404:
          $ref: '#/components/responses/NotFound'
        500:
          $ref: '#/components/responses/ServerError'

  /personalize:
    post:
      summary: Generate personalized chapter
      description: |
        Rewrite chapter content based on user profile (OS, GPU, experience level, robotics background).

        Uses Claude API with caching (30-day TTL).

        **Response time**: 10–25 seconds (SC-003)
      operationId: personalizeChapter
      tags: [personalization]
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [chapter_id]
              properties:
                chapter_id:
                  type: integer
                  minimum: 1
                  maximum: 6
                  example: 1
      responses:
        200:
          description: Personalized chapter content
          content:
            application/json:
              schema:
                type: object
                required: [personalized_text, cached]
                properties:
                  personalized_text:
                    type: string
                    description: Rewritten chapter for user profile
                  cached:
                    type: boolean
                    description: Whether response came from cache (true) or was generated (false)
                  generated_at:
                    type: string
                    format: date-time
                  expires_at:
                    type: string
                    format: date-time
                    description: Cache expiration (30 days from generation)
        400:
          description: Invalid chapter_id
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        401:
          $ref: '#/components/responses/Unauthorized'
        429:
          description: Rate limit exceeded (max 10 personalization requests per hour)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        500:
          $ref: '#/components/responses/ServerError'

  /translate:
    post:
      summary: Translate chapter to Urdu
      description: |
        Translate chapter content to Urdu using Claude API.

        Respects code blocks and LaTeX (does not translate).

        Uses caching (30-day TTL).

        **Response time**: 10–25 seconds (SC-004)
      operationId: translateChapter
      tags: [translation]
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [chapter_id, language]
              properties:
                chapter_id:
                  type: integer
                  minimum: 1
                  maximum: 6
                  example: 1
                language:
                  type: string
                  enum: [urdu]
                  description: Target language (only Urdu in MVP)
      responses:
        200:
          description: Translated chapter
          content:
            application/json:
              schema:
                type: object
                required: [translated_text, language, cached]
                properties:
                  translated_text:
                    type: string
                  language:
                    type: string
                    example: urdu
                  cached:
                    type: boolean
                  translated_at:
                    type: string
                    format: date-time
                  expires_at:
                    type: string
                    format: date-time
        400:
          description: Invalid chapter_id or language
        401:
          $ref: '#/components/responses/Unauthorized'
        429:
          description: Rate limit exceeded
        500:
          $ref: '#/components/responses/ServerError'

  /chat:
    post:
      summary: RAG chatbot with semantic search
      description: |
        Ask question about chapter content.

        Uses semantic search (Qdrant) + Claude API to generate grounded response.

        **Response time**: <5 seconds average (SC-005)

        **Citations**: 100% of citations verified against chapter content (SC-006)
      operationId: chat
      tags: [chat]
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [chapter_id, user_message]
              properties:
                chapter_id:
                  type: integer
                  minimum: 1
                  maximum: 6
                  description: Chapter context
                user_message:
                  type: string
                  minLength: 1
                  maxLength: 1000
                  example: How do I set up ROS 2 on Ubuntu?
      responses:
        200:
          description: Chatbot response with citations
          content:
            application/json:
              schema:
                type: object
                required: [assistant_response, citations]
                properties:
                  assistant_response:
                    type: string
                    description: Claude API response
                  citations:
                    type: array
                    items:
                      $ref: '#/components/schemas/Citation'
                    description: Array of citations (SC-006)
                  source_chapters:
                    type: array
                    items:
                      type: integer
                    description: Chapter IDs used in RAG retrieval
                  tokens_used:
                    type: integer
                    description: Tokens consumed in this request
                  generated_at:
                    type: string
                    format: date-time
              example:
                assistant_response: To set up ROS 2 on Ubuntu, first install the ROS 2 distribution via apt...
                citations:
                  - chapter_id: 2
                    section_title: "2.2 Installation Steps"
                    excerpt: "apt install ros-humble-desktop"
                source_chapters: [2]
                tokens_used: 342
        400:
          description: Invalid input (missing chapter_id, empty message)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        401:
          $ref: '#/components/responses/Unauthorized'
        429:
          description: Rate limit exceeded (max 30 chat requests per hour)
        500:
          $ref: '#/components/responses/ServerError'

  /health:
    get:
      summary: Health check
      description: |
        Verify API and backend services are operational.

        Checks: database connectivity, Qdrant availability, Claude API access.
      operationId: healthCheck
      tags: [admin]
      responses:
        200:
          description: All services operational
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    enum: [ok, degraded, down]
                  services:
                    type: object
                    properties:
                      database:
                        type: string
                        enum: [ok, down]
                      qdrant:
                        type: string
                        enum: [ok, down]
                      claude_api:
                        type: string
                        enum: [ok, down]
                  timestamp:
                    type: string
                    format: date-time
        503:
          description: One or more services unavailable
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

security:
  - BearerAuth: []
